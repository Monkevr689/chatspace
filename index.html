<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatSpace â€” Group Chat (No Login)</title>
  <meta name="description" content="Groups + realtime chat using Firebase Realtime Database. No login required.">
  <style>
    :root {--bg:#f7f7f8;--card:#fff;--border:#e5e7eb;--text:#111827;--muted:#6b7280;--accent:#3b82f6}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{background:var(--accent);color:#fff;padding:10px 16px;display:flex;align-items:center;gap:10px;justify-content:space-between}
    header .brand{display:flex;align-items:center;gap:10px}
    header img{height:40px;width:40px;border-radius:50%}
    header h1{font-size:18px;margin:0}
    .wrap{max-width:1060px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:10px 0}
    .row{display:flex;align-items:center;gap:8px}
    .row.sb{justify-content:space-between}
    .btn{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border:none}
    .btn.primary:hover{opacity:.9}
    .input{padding:8px 10px;border-radius:10px;border:1px solid var(--border);flex:1}
    .grid{display:grid;grid-template-columns:300px 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .list{display:flex;flex-direction:column;gap:6px}
    .group{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:10px;padding:8px}
    #messages{display:flex;flex-direction:column;gap:8px;max-height:55vh;overflow:auto}
    .msg{border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff}
    .me{background:#eef2ff}
    .muted{color:var(--muted);font-size:13px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    textarea{width:100%;min-height:78px;padding:8px;border:1px solid var(--border);border-radius:10px;resize:vertical}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://upload.wikimedia.org/wikipedia/commons/7/7c/Chat_icon.png" alt="logo">
      <h1>ChatSpace â€” Groups</h1>
    </div>
    <div class="muted">Realtime group chat (no login)</div>
  </header>

  <div class="wrap">
    <div id="status" class="muted" style="margin:6px 0;"></div>

    <!-- username -->
    <div class="card">
      <div class="row">
        <input id="me" class="input" placeholder="choose a username (e.g. alice)">
        <button id="claim" class="btn primary">Claim username</button>
        <div class="muted mono">Share: <span id="share"></span></div>
      </div>
    </div>

    <div class="grid">
      <!-- left: groups -->
      <div>
        <div class="card">
          <h3>Create / Join a Group</h3>
          <div class="row">
            <input id="groupName" class="input" placeholder="group name (e.g. class7)" />
            <button id="joinGroup" class="btn primary">Create / Join</button>
          </div>
          <p class="muted" style="margin-top:6px">Tip: anyone typing the same group name joins the same room.</p>
        </div>

        <div class="card">
          <h3>My Groups</h3>
          <div id="myGroups" class="list"></div>
        </div>

        <div class="card">
          <h3>Members of <span id="gNameMono" class="mono">â€”</span></h3>
          <div id="members" class="list"></div>
        </div>
      </div>

      <!-- right: messages -->
      <div>
        <div class="card">
          <h3>Group: <span id="activeGroup" class="mono">â€”</span></h3>
          <div id="messages"></div>
          <div class="row" style="margin-top:10px">
            <textarea id="msg" placeholder="Type a messageâ€¦ (Enter to send)"></textarea>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:6px">
            <button id="send" class="btn primary">Send to Group</button>
          </div>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:8px">Data paths used: <span class="mono">/groups/{g}, /group_members/{g}/{user}, /user_groups/{user}/{g}, /group_messages/{g}/{autoId}</span></p>
  </div>

  <!-- Firebase SDK v10 (no Auth used) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, push, get, child } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // ðŸ”— Your DB
    const firebaseConfig = {
      databaseURL: "https://my-chat-ddcd1-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // helpers
    const $ = s => document.querySelector(s);
    const t = () => Date.now();
    const esc = s => (s||"").replace(/[<>&]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]));

    // elements
    const meBox=$('#me'), claimBtn=$('#claim'), share=$('#share'),
          groupName=$('#groupName'), joinGroupBtn=$('#joinGroup'),
          myGroups=$('#myGroups'), members=$('#members'),
          activeGroupLabel=$('#activeGroup'), gNameMono=$('#gNameMono'),
          messages=$('#messages'), msg=$('#msg'), send=$('#send'),
          status=$('#status');

    let me=null, currentGroup=null;
    let msgUnsub=null, memUnsub=null;

    function info(m){ status.textContent=m; setTimeout(()=>status.textContent='',2000); }

    // Claim username (public, first come first served)
    async function claimUsername(){
      const u=(meBox.value||'').trim().toLowerCase();
      if(!u) return;
      const s=await get(child(ref(db), 'users/'+u));
      if(s.exists()){ alert('That username is taken.'); return; }
      await set(ref(db, 'users/'+u), { createdAt: t() });
      me=u;
      history.replaceState({},'',location.pathname+'?u='+me);
      share.textContent = location.origin + location.pathname + '?u=' + me;
      info('Username set.');
      watchMyGroups();
    }

    // Create or join a group
    async function joinGroup(){
      if(!me) return info('Claim a username first.');
      const g = (groupName.value||'').trim().toLowerCase();
      if(!g) return;

      // ensure group exists
      await set(ref(db, 'groups/'+g), { createdAt: t() });

      // add membership (both directions for easy lists)
      await update(ref(db), {
        ['group_members/'+g+'/'+me]: true,
        ['user_groups/'+me+'/'+g]: true
      });

      openGroup(g);
      groupName.value='';
      info('Joined '+g);
    }

    // Show my groups
    function watchMyGroups(){
      if(!me) return;
      onValue(ref(db, 'user_groups/'+me), (snap)=>{
        const data = snap.val() || {};
        const list = Object.keys(data).sort();
        myGroups.innerHTML = list.length
          ? list.map(g=>`<div class="group"><div>#${esc(g)}</div><button class="btn primary" data-open="${esc(g)}">Open</button></div>`).join('')
          : '<div class="muted">You are not in any groups yet.</div>';
      });
    }

    // Open a group: subscribe to messages + members
    function openGroup(g){
      currentGroup = g;
      activeGroupLabel.textContent = '#'+g;
      gNameMono.textContent = '#'+g;
      messages.innerHTML = '';

      // unsubscribe old listeners if any
      if (msgUnsub) msgUnsub();  if (memUnsub) memUnsub();

      // messages
      const msgsRef = ref(db, 'group_messages/'+g);
      const offMsgs = onValue(msgsRef, (snap)=>{
        const d=snap.val()||{};
        const arr = Object.values(d).sort((a,b)=>a.ts-b.ts);
        messages.innerHTML = arr.map(m=>{
          const mine = m.from===me ? ' me' : '';
          return `<div class="msg${mine}">
            <div class="muted mono">@${esc(m.from)}</div>
            <div>${esc(m.text)}</div>
          </div>`;
        }).join('');
        messages.scrollTop = messages.scrollHeight;
      });
      msgUnsub = () => offMsgs();

      // members
      const memRef = ref(db, 'group_members/'+g);
      const offMem = onValue(memRef, (snap)=>{
        const d=snap.val()||{};
        const list = Object.keys(d).sort();
        members.innerHTML = list.map(u=>`<div class="group"><div>@${esc(u)}</div></div>`).join('');
      });
      memUnsub = () => offMem();
    }

    // Send message to current group
    async function sendMessage(){
      const text = (msg.value||'').trim();
      if(!text) return;
      if(!me) return info('Claim a username first.');
      if(!currentGroup) return info('Open or join a group first.');
      await push(ref(db, 'group_messages/'+currentGroup), {
        from: me, text, ts: t()
      });
      msg.value='';
    }

    // Events
    claimBtn.addEventListener('click', claimUsername);
    joinGroupBtn.addEventListener('click', joinGroup);
    send.addEventListener('click', sendMessage);
    msg.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
    document.body.addEventListener('click', e=>{
      const g = e.target.getAttribute('data-open'); if(g) return openGroup(g);
    });

    // Auto-claim via ?u=alice
    const params = new URLSearchParams(location.search);
    const u = (params.get('u')||'').trim().toLowerCase();
    if(u){ meBox.value=u; claimUsername(); }
  </script>
</body>
</html>


