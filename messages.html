<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ChatSpace â€” Messages</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --border:#e6e8ef; --text:#0f172a; --muted:#64748b;
    --accent:#3b82f6; --danger:#ef4444; --bubble:#fff; --me:#eef2ff; --link:#2563eb
  }
  :root[data-theme="dark"]{
    --bg:#0b1220; --card:#0f172a; --border:#1f2a44; --text:#e5e7eb; --muted:#93a4c7;
    --accent:#60a5fa; --danger:#f87171; --bubble:#111827; --me:#1e293b; --link:#93c5fd
  }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Arial;color:var(--text);background:var(--bg)}
  a{color:var(--link)}
  header{position:sticky;top:0;z-index:5;background:var(--card);border-bottom:1px solid var(--border);padding:10px 12px}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
  .left,.right{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:transparent;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  .col{display:flex;flex-direction:column;gap:10px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .input, textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)}
  .list>*+*{border-top:1px solid var(--border);margin-top:8px;padding-top:8px}
  #chat{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
  .bubble{border:1px solid var(--border);background:var(--bubble);border-radius:12px;padding:10px}
  .me{background:var(--me)}
  .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  .userItem{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px}
  img.msg{max-width:260px;border-radius:10px;display:block;margin-top:6px}
  .tiny{font-size:12px;color:var(--muted)}
  .pill{padding:2px 6px;border-radius:6px;border:1px solid var(--border);margin-left:6px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="left">
      <strong>ChatSpace</strong>
      <a class="btn" href="./messages.html">ðŸ’¬ Messages</a>
      <a class="btn" href="./groups.html">ðŸ‘¥ Groups</a>
    </div>
    <div class="right">
      <button id="themeBtn" class="btn">ðŸŒ“ Theme: <span id="themeName">Light</span></button>
      <button id="soundBtn" class="btn">ðŸ”Š Sound: <span id="soundState">On</span></button>
      <button id="notifBtn" class="btn">ðŸ”” Notifications</button>
      <button id="testNotif" class="btn">âœ… Test</button>
    </div>
  </div>
</header>

<div class="wrap col">
  <div id="status" class="tiny"></div>

  <!-- identity -->
  <div class="card">
    <div class="row">
      <input id="me" class="input" placeholder="username (e.g. alice)"/>
      <button id="claim" class="btn primary">Use</button>
      <span id="adminBadge" class="tiny pill"></span>
      <span class="tiny">Share: <span id="share" class="mono"></span></span>
    </div>
  </div>

  <div class="grid">
    <!-- left: requests + friends + users -->
    <div class="col">
      <div class="card">
        <div class="row">
          <input id="findUser" class="input" placeholder="find usernameâ€¦"/>
          <button id="sendReq" class="btn">Add Friend</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">Incoming</h3>
        <div id="incoming" class="list tiny"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">Friends</h3>
        <div id="friends" class="list tiny"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">Registered Users</h3>
        <div id="registered" class="col"></div>
        <div class="tiny">As <b>tosh1</b> you can delete users.</div>
      </div>
    </div>

    <!-- right: chat -->
    <div class="col">
      <div class="card col">
        <div class="row" style="justify-content:space-between">
          <div>Chatting with <span id="peer" class="mono">â€”</span></div>
        </div>

        <div id="chat"></div>

        <!-- image PREVIEW bubble (local only, not sent yet) -->
        <div id="previewWrap" class="bubble" style="display:none;opacity:0.9">
          <div class="muted mono">Preview (not sent)</div>
          <img id="previewImg" class="msg" alt="preview">
        </div>

        <!-- composer -->
        <div class="row"><textarea id="msg" placeholder="Type a messageâ€¦ (Enter to send)"></textarea></div>
        <div class="row" style="justify-content:space-between">
          <input id="file" type="file" accept="image/*"/>
          <div class="row">
            <button id="send" class="btn primary">Send</button>
            <button id="clearFile" class="btn">Clear preview</button>
          </div>
        </div>
        <div class="tiny">Pick an image to **show it instantly** above as a preview. Press Send to upload & deliver.</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, onValue, off, set, update, push, get, child, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

const app = initializeApp({ databaseURL: "https://my-chat-ddcd1-default-rtdb.firebaseio.com/" });
const db = getDatabase(app);
const storage = getStorage(app);

// ===== Theme, Sound, Notifications (top bar) =====
const root = document.documentElement;
const themeBtn = document.querySelector('#themeBtn');
const themeName = document.querySelector('#themeName');
const savedTheme = localStorage.getItem('cs_theme') || 'light';
applyTheme(savedTheme);
function applyTheme(th){ root.setAttribute('data-theme', th==='dark'?'dark':'light'); themeName.textContent = th==='dark'?'Dark':'Light'; localStorage.setItem('cs_theme', th); }
themeBtn.onclick = ()=> applyTheme(root.getAttribute('data-theme')==='dark' ? 'light' : 'dark');

let soundOn = (localStorage.getItem("cs_sound")||"on")==="on";
const soundState=document.querySelector("#soundState");
document.querySelector("#soundBtn").onclick=()=>{ soundOn=!soundOn; localStorage.setItem("cs_sound",soundOn?"on":"off"); soundState.textContent=soundOn?"On":"Off"; if(soundOn){ ensureAudio(); ding(); } };
soundState.textContent = soundOn ? "On" : "Off";
let audioCtx=null; function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } if(audioCtx&&audioCtx.state==="suspended"){ audioCtx.resume(); } }
function ding(){ if(!soundOn) return; ensureAudio(); if(!audioCtx) return; const c=audioCtx; let s=c.currentTime; [[660,0.18],[990,0.28]].forEach(([f,d])=>{ const o=c.createOscillator(), g=c.createGain(); o.type="square"; o.frequency.setValueAtTime(f,s); g.gain.setValueAtTime(0.0001,s); g.gain.exponentialRampToValueAtTime(0.22,s+0.02); g.gain.exponentialRampToValueAtTime(0.0001,s+d); o.connect(g).connect(c.destination); o.start(s); o.stop(s+d+0.01); s+=d+0.02;}); }
window.addEventListener("click", ensureAudio, { once:true });

const notifBtn=document.querySelector('#notifBtn');
const testBtn=document.querySelector('#testNotif');
notifBtn.onclick = async ()=>{ if(!("Notification" in window)) return alert("No Notification support"); const p=await Notification.requestPermission(); if(p!=="granted") alert("Allow notifications in your browser settings."); else new Notification("Notifications enabled ðŸŽ‰"); };
testBtn.onclick = ()=>{ if("Notification" in window && Notification.permission==="granted"){ new Notification("Test notification", { body:"It works!" }); } else alert("Enable notifications first."); };

// ===== helpers =====
const $=s=>document.querySelector(s), t=()=>Date.now(), tid=(a,b)=>[a,b].sort().join("__");
const esc=s=>(s||"").replace(/[<>&]/g,m=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[m]));
const info=m=>{const el=$("#status"); el.textContent=m; setTimeout(()=>el.textContent="",2200);};

// els
const meBox=$("#me"), claim=$("#claim"), share=$("#share"), adminBadge=$("#adminBadge");
const incoming=$("#incoming"), friends=$("#friends"), registered=$("#registered");
const peerEl=$("#peer"), chat=$("#chat"), msg=$("#msg"), send=$("#send");
const file=$("#file"), clearFile=$("#clearFile"), previewWrap=$("#previewWrap"), previewImg=$("#previewImg");
const findUser=$("#findUser"), sendReq=$("#sendReq");

let me=null, admin=false, currentPeer=null, dmRef=null, dmCb=null;

// presence
async function presence(){
  if(!me) return;
  const p=ref(db,'presence/'+me);
  await set(p,{online:true,lastSeen:serverTimestamp()});
  onDisconnect(p).set({online:false,lastSeen:serverTimestamp()});
  setInterval(()=>update(p,{online:true,lastSeen:serverTimestamp()}),30000);
}

async function use(){
  const u=(meBox.value||'').trim().toLowerCase(); if(!u) return;
  const s=await get(child(ref(db),'users/'+u)); if(!s.exists()) await set(ref(db,'users/'+u),{createdAt:t()});
  me=u; admin=(me==='tosh1');
  localStorage.setItem("cs_username",me);
  history.replaceState({},'',location.pathname+'?u='+me);
  share.textContent=location.origin+location.pathname+'?u='+me;
  adminBadge.textContent = admin ? 'Admin: tosh1' : '';
  info('Using @'+me+(admin?' (admin)':''));
  presence();
  lists(); watchUsers();
}
claim.onclick=use;
const saved=(localStorage.getItem("cs_username")||"").trim(); if(saved){ meBox.value=saved; use(); }

// lists
function lists(){
  if(!me) return;
  let prev=0;
  onValue(ref(db,'requests/'+me),(snap)=>{
    const d=snap.val()||{};
    const inc=Object.entries(d).filter(([,r])=>r.status==='pending').map(([from,r])=>({from,ts:r.ts})).sort((a,b)=>b.ts-a.ts);
    if(inc.length>prev){ ding(); if("Notification" in window && Notification.permission==="granted"){ new Notification('New friend request',{body:'@'+inc[0].from}); } }
    prev=inc.length;
    incoming.innerHTML = inc.length ? inc.map(r=>`
      <div class="row">
        <span>@${esc(r.from)}</span>
        <button class="btn primary" data-accept="${esc(r.from)}">Accept</button>
        <button class="btn" data-decline="${esc(r.from)}">Decline</button>
      </div>`).join('') : '<span class="muted">None</span>';
  });
  onValue(ref(db,'friendships/'+me),(snap)=>{
    const f=snap.val()||{}; const arr=Object.keys(f).sort();
    friends.innerHTML = arr.length ? arr.map(u=>`
      <div class="row">
        <span>@${esc(u)}</span>
        <button class="btn primary" data-open="${esc(u)}">Open</button>
      </div>`).join('') : '<span class="muted">No friends yet</span>';
  });
}

function watchUsers(){
  onValue(ref(db,'users'), (su)=>{
    const users=su.val()||{};
    registered.innerHTML = Object.keys(users).sort().map(u=>`
      <div class="userItem">
        <span>@${esc(u)}</span>
        <div class="row">
          <button class="btn" data-add="${esc(u)}">Add</button>
          ${admin && u!=='tosh1' ? `<button class="btn danger" data-deluser="${esc(u)}">Delete</button>`:''}
        </div>
      </div>`).join('');
  });
}

// local IMAGE PREVIEW (not sent)
file.addEventListener('change', ()=>{
  if(file.files && file.files[0]){
    const url = URL.createObjectURL(file.files[0]);
    previewImg.src = url;
    previewWrap.style.display = 'block';
  } else {
    previewWrap.style.display = 'none';
    previewImg.removeAttribute('src');
  }
});
clearFile.onclick = ()=>{ file.value=''; previewWrap.style.display='none'; previewImg.removeAttribute('src'); };

// dm open/render
function render(arr){
  chat.innerHTML = arr.map(m=>`
    <div class="bubble ${m.from===me?'me':''}">
      <div class="muted mono">@${esc(m.from)}</div>
      ${m.text?`<div>${esc(m.text)}</div>`:''}
      ${m.imageUrl?`<img class="msg" src="${esc(m.imageUrl)}" alt="image">`:''}
      ${(admin||m.from===me)?`<button class="btn tiny" data-del="${esc(m.id)}">ðŸ—‘</button>`:''}
    </div>`).join('');
  chat.scrollTop = chat.scrollHeight;
}

function openDM(peer){
  currentPeer=peer; peerEl.textContent='@'+peer; chat.innerHTML='';
  if(dmRef && dmCb) off(dmRef, dmCb);
  let last=0;
  dmRef = ref(db,'messages/'+tid(me,peer));
  dmCb = (snap)=>{
    const d=snap.val()||{}; const arr=Object.entries(d).map(([id,m])=>({id,...m})).sort((a,b)=>a.ts-b.ts);
    if(arr.length>last){
      const L=arr[arr.length-1]; if(L && L.from!==me){ ding(); if("Notification" in window && Notification.permission==="granted"){ new Notification("New message from @"+L.from,{body:L.text||'Photo'}); } }
    }
    last=arr.length; render(arr);
  };
  onValue(dmRef, dmCb);
}

async function sendMsg(){
  if(!currentPeer) return;
  const text=(msg.value||'').trim();
  let imageUrl=null;
  if(file.files && file.files[0]){
    // upload then weâ€™ll clear preview
    const f=file.files[0];
    const path=`uploads/${me}/${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
    const upRef=sref(storage, path);
    await uploadBytes(upRef, f);
    imageUrl = await getDownloadURL(upRef);
  }
  if(!text && !imageUrl) return;
  await push(ref(db,'messages/'+tid(me,currentPeer)), { from: me, to: currentPeer, text, imageUrl, ts:t() });
  msg.value='';
  if(imageUrl){ file.value=''; previewWrap.style.display='none'; previewImg.removeAttribute('src'); }
}
send.onclick=sendMsg;
msg.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMsg(); } });

// actions
async function addFriend(u){
  if(!me) return;
  const s=await get(child(ref(db),'users/'+u)); if(!s.exists()) return alert('User not found');
  await set(ref(db,'requests/'+u+'/'+me), { status:'pending', ts:t() }); info('Request sent.');
}
async function accept(u){
  await update(ref(db),{
    ['requests/'+me+'/'+u+'/status']:'accepted',
    ['friendships/'+me+'/'+u]:true,['friendships/'+u+'/'+me]:true
  }); info('Accepted.');
}
async function decline(u){ await update(ref(db),{['requests/'+me+'/'+u+'/status']:'declined'}); info('Declined.'); }
async function delMsg(id){ if(!currentPeer) return; await remove(ref(db,'messages/'+tid(me,currentPeer)+'/'+id)); }
async function delUser(u){
  if(!(me==='tosh1')||u==='tosh1') return;
  if(!confirm(`Delete @${u}?`)) return;
  const [friendsSnap, groupsSnap, requestsSnap, messagesSnap]=await Promise.all([
    get(child(ref(db),'friendships/'+u)), get(child(ref(db),'user_groups/'+u)),
    get(child(ref(db),'requests')), get(child(ref(db),'messages'))
  ]);
  const updates={};
  updates['users/'+u]=null; updates['presence/'+u]=null; updates['requests/'+u]=null;
  const reqAll=requestsSnap.val()||{}; Object.keys(reqAll).forEach(target=>{ if(reqAll[target]?.[u]) updates['requests/'+target+'/'+u]=null; });
  const fr=friendsSnap.val()||{}; Object.keys(fr).forEach(p=>{ updates['friendships/'+u+'/'+p]=null; updates['friendships/'+p+'/'+u]=null; });
  const msgsRoot=messagesSnap.val()||{}; Object.keys(msgsRoot).forEach(k=>{ if(k.split('__').includes(u)) updates['messages/'+k]=null; });
  const ug=groupsSnap.val()||{}; Object.keys(ug).forEach(g=>{ updates['group_members/'+g+'/'+u]=null; });
  updates['user_groups/'+u]=null;
  await update(ref(db), updates);
  info('@'+u+' deleted');
}

document.body.addEventListener('click',(e)=>{
  const o=e.target.getAttribute('data-open'); if(o){ openDM(o); return; }
  const a=e.target.getAttribute('data-accept'); if(a){ accept(a); return; }
  const d=e.target.getAttribute('data-decline'); if(d){ decline(d); return; }
  const add=e.target.getAttribute('data-add'); if(add){ addFriend(add); return; }
  const del=e.target.getAttribute('data-del'); if(del){ delMsg(del); return; }
  const du=e.target.getAttribute('data-deluser'); if(du){ delUser(du); return; }
});
sendReq.onclick=async()=>{ const u=(findUser.value||'').trim().toLowerCase(); if(u) addFriend(u); };
</script>
</body>
</html>
