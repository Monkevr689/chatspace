<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ChatSpace â€” Messages (Admin + Long Ding)</title>
<style>
  :root{--bg:#f7f7f8;--card:#fff;--border:#e5e7eb;--text:#111827;--muted:#6b7280;--accent:#3b82f6;--danger:#ef4444}
  *{box-sizing:border-box}body{margin:0;font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}
  header{background:#fff;border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .nav a{margin-left:8px;text-decoration:none;padding:8px 12px;border:1px solid var(--border);border-radius:999px;color:var(--text)}
  .nav a.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .wrap{max-width:1180px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:10px 0}
  .row{display:flex;align-items:center;gap:8px}.row.end{justify-content:flex-end}
  .input{padding:8px 10px;border-radius:10px;border:1px solid var(--border);flex:1}
  .btn{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border:none}
  .btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .grid{display:grid;grid-template-columns:320px 1fr 320px;gap:12px}
  @media(max-width:1100px){.grid{grid-template-columns:1fr}}
  .list>*+*{border-top:1px solid var(--border);margin-top:8px;padding-top:8px}
  .bubble{border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff;position:relative}
  .bubble .del{position:absolute;top:6px;right:6px}
  #dmChat{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
  .me{background:#eef2ff}
  .userItem{display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px solid var(--border);border-radius:10px}
  .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%;margin-right:6px;background:#9ca3af}.dot.online{background:#10b981}
  .tiny{font-size:12px;color:var(--muted)}
</style>
</head><body>
<header>
  <strong>ChatSpace â€” Messages</strong>
  <div class="row">
    <span id="adminBadge" class="tiny"></span>
    <button id="toggleSound" class="btn">ðŸ”Š Sound: <span id="soundState">On</span></button>
    <button id="enablePush" class="btn">ðŸ”” Enable desktop notifications</button>
    <nav class="nav">
      <a class="active" href="./messages.html">ðŸ’¬ Messages</a>
      <a href="./groups.html">ðŸ‘¥ Groups</a>
    </nav>
  </div>
</header>

<div class="wrap">
  <div id="status" class="muted" style="margin:6px 0;"></div>

  <div class="card">
    <div class="row">
      <input id="me" class="input" placeholder="choose a username (e.g. alice)">
      <button id="claim" class="btn primary">Use / Claim</button>
      <div class="muted mono">Share: <span id="share"></span></div>
    </div>
    <div class="tiny">Tip: username is remembered on this device.</div>
  </div>

  <div class="grid">
    <!-- Left: requests + friends -->
    <div>
      <div class="card">
        <h3>Find someone</h3>
        <div class="row">
          <input id="findUser" class="input" placeholder="enter username (e.g. bob)">
          <button id="sendReq" class="btn primary">Add Friend</button>
        </div>
      </div>

      <div class="card">
        <h3>Incoming</h3>
        <div id="incoming" class="list"></div>
        <h3 style="margin-top:10px">Friends</h3>
        <div id="friends" class="list"></div>
      </div>
    </div>

    <!-- Middle: DM chat -->
    <div>
      <div class="card">
        <h3>Chatting with <span id="dmWith" class="mono">â€”</span></h3>
        <div id="dmChat"></div>
        <div class="row end" style="margin-top:8px">
          <textarea id="dmMsg" class="input" placeholder="Type a messageâ€¦ (Enter to send)"></textarea>
          <button id="dmSend" class="btn primary">Send</button>
        </div>
      </div>
    </div>

    <!-- Right: Registered Users (Add Friend + Admin Delete User) -->
    <div>
      <div class="card">
        <h3>Registered Users</h3>
        <div id="registeredUsers" class="list"></div>
        <div class="tiny">As <b>tosh1</b> youâ€™ll also see a Delete User button.</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, onValue, off, set, update, push, get, child, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const app = initializeApp({ databaseURL: "https://my-chat-ddcd1-default-rtdb.firebaseio.com/" });
const db = getDatabase(app);

// ====== SOUND (longer two-tone ding) + PUSH ======
let soundEnabled = (localStorage.getItem("cs_sound")||"on") === "on";
const soundStateEl = document.querySelector("#soundState");
soundStateEl.textContent = soundEnabled ? "On" : "Off";
let audioCtx = null;
function ensureAudioCtx(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } if(audioCtx&&audioCtx.state==="suspended"){ audioCtx.resume(); } }
function dingLong(){
  if(!soundEnabled) return; ensureAudioCtx(); if(!audioCtx) return;
  const ctx=audioCtx;
  const seq=[ {f:660,d:0.18}, {f:990,d:0.28} ];
  let start=ctx.currentTime;
  seq.forEach(({f,d},i)=>{
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type="square"; o.frequency.setValueAtTime(f,start);
    g.gain.setValueAtTime(0.0001,start);
    g.gain.exponentialRampToValueAtTime(0.22,start+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,start+d);
    o.connect(g).connect(ctx.destination); o.start(start); o.stop(start+d+0.01);
    start += d+0.02;
  });
}
document.querySelector("#toggleSound").onclick=()=>{ soundEnabled=!soundEnabled; localStorage.setItem("cs_sound", soundEnabled?"on":"off"); soundStateEl.textContent=soundEnabled?"On":"Off"; if(soundEnabled){ ensureAudioCtx(); dingLong(); } };
window.addEventListener("click", ensureAudioCtx, { once:true });

const pushBtn = document.querySelector("#enablePush");
pushBtn.onclick = async () => {
  if(!("Notification" in window)) return alert("Notifications not supported.");
  const perm = await Notification.requestPermission();
  if(perm !== "granted") return;
  new Notification("Desktop notifications enabled ðŸŽ‰");
};
function notify(title, body){ if("Notification" in window && Notification.permission==="granted"){ new Notification(title, { body }); } }

// ====== helpers ======
const $=s=>document.querySelector(s), t=()=>Date.now(), tid=(a,b)=>[a,b].sort().join("__");
const esc = s => (s||"").replace(/[<>&]/g,m=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[m]));
const info=m=>{const el=$("#status"); el.textContent=m; setTimeout(()=>el.textContent="",2500);};

// elements
const meBox=$("#me"), claimBtn=$("#claim"), share=$("#share"), adminBadge=$("#adminBadge");
const incoming=$("#incoming"), friends=$("#friends");
const findUser=$("#findUser"), sendReq=$("#sendReq");
const dmWith=$("#dmWith"), dmChat=$("#dmChat"), dmMsg=$("#dmMsg"), dmSend=$("#dmSend");
const regUsers=$("#registeredUsers");
let me=null, isAdmin=false, dmRef=null, dmCb=null, currentDM=null;

// Presence
async function startPresence(){
  if(!me) return;
  const pRef = ref(db,'presence/'+me);
  await set(pRef, { online:true, lastSeen: serverTimestamp() });
  onDisconnect(pRef).set({ online:false, lastSeen: serverTimestamp() });
  setInterval(()=>{ update(pRef,{online:true,lastSeen:serverTimestamp()}); }, 30000);
}

async function useOrClaim(){
  const u=(meBox.value||'').trim().toLowerCase(); if(!u) return;
  const s=await get(child(ref(db),'users/'+u));
  if(!s.exists()) await set(ref(db,'users/'+u), { createdAt:t() });
  me=u; isAdmin = (me === 'tosh1');
  localStorage.setItem("cs_username",me);
  history.replaceState({},'',location.pathname+'?u='+me);
  share.textContent=location.origin+location.pathname+'?u='+me;
  adminBadge.textContent = isAdmin ? "Admin: tosh1" : "";
  info("Using username: "+me+(isAdmin?" (admin)":""));
  startPresence();
  loadDMLists(); watchUsers();
}
claimBtn.onclick=useOrClaim;
const saved=(localStorage.getItem("cs_username")||'').trim(); if(saved){ meBox.value=saved; useOrClaim(); }

// DM lists + ding on new request / new message
function loadDMLists(){
  if(!me) return;
  let prevPending=0;
  onValue(ref(db,'requests/'+me),(snap)=>{
    const d=snap.val()||{};
    const inc = Object.entries(d).filter(([,r])=>r.status==='pending').map(([from,r])=>({from,ts:r.ts})).sort((a,b)=>b.ts-a.ts);
    if(inc.length>prevPending){ dingLong(); notify("New friend request", `@${inc[0].from} sent you a request`); }
    prevPending=inc.length;
    incoming.innerHTML = inc.length ? inc.map(r=>`
      <div class="row"><div>@${esc(r.from)}</div>
      <button class="btn primary" data-accept="${esc(r.from)}">Accept</button>
      <button class="btn" data-decline="${esc(r.from)}">Decline</button></div>`).join('') : '<div class="muted">No pending.</div>';
  });
  onValue(ref(db,'friendships/'+me),(snap)=>{
    const f=snap.val()||{}; const arr=Object.keys(f);
    friends.innerHTML = arr.length ? arr.map(u=>`
      <div class="row"><div>@${esc(u)}</div>
      <button class="btn primary" data-open-dm="${esc(u)}">Message</button></div>`).join('') : '<div class="muted">No friends yet.</div>';
  });
}

// users + presence (Add Friend + Admin Delete User)
function watchUsers(){
  onValue(ref(db,'users'), (snapUsers)=>{
    const allUsers=snapUsers.val()||{};
    onValue(ref(db,'presence'), (snapP)=>{
      const pres=snapP.val()||{};
      const names=Object.keys(allUsers).sort();
      regUsers.innerHTML = names.length ? names.map(u=>{
        const online = pres[u]?.online ? 'online' : '';
        return `<div class="userItem">
          <div class="row"><span class="dot ${online}"></span><strong>@${esc(u)}</strong></div>
          <div class="row">
            <button class="btn" data-add-friend="${esc(u)}">Add Friend</button>
            ${isAdmin && u!=='tosh1' ? `<button class="btn danger" data-del-user="${esc(u)}">Delete</button>`:''}
          </div>
        </div>`;
      }).join('') : '<div class="muted">No registered users yet.</div>';
    });
  });
}

async function sendRequest(targetName){
  const target = (targetName || findUser.value || '').trim().toLowerCase();
  if(!target||!me) return;
  const s=await get(child(ref(db),'users/'+target));
  if(!s.exists()) return alert('User not found. Ask them to claim a username first.');
  await set(ref(db,'requests/'+target+'/'+me), { status:'pending', ts:t() });
  info('Request sent.'); findUser.value='';
}

function renderDM(arr){
  dmChat.innerHTML = arr.map(m=>`
    <div class="bubble ${m.from===me?'me':''}" data-msgid="${esc(m.id)}">
      <div class="muted mono">@${esc(m.from)}</div>
      <div>${esc(m.text)}</div>
      ${(isAdmin || m.from===me)? `<button class="btn tiny del" data-del-dm="${esc(m.id)}">ðŸ—‘</button>`:''}
    </div>`).join('');
  dmChat.scrollTop = dmChat.scrollHeight;
}

function openDM(peer){
  currentDM=peer; dmWith.textContent='@'+peer; dmChat.innerHTML='';
  if(dmRef && dmCb) off(dmRef, dmCb);
  dmRef = ref(db,'messages/'+tid(me,peer));
  let lastCount = 0;
  dmCb = (snap)=>{
    const msgs=snap.val()||{}; const arr=Object.entries(msgs).map(([id,m])=>({id,...m})).sort((a,b)=>a.ts-b.ts);
    if(arr.length>lastCount){
      const latest=arr[arr.length-1];
      if(latest && latest.from!==me){ dingLong(); notify(`New message from @${latest.from}`, latest.text||''); }
    }
    lastCount=arr.length;
    renderDM(arr);
  };
  onValue(dmRef, dmCb);
}

async function sendDM(){
  const text=(dmMsg.value||'').trim(); if(!text||!currentDM) return;
  await push(ref(db,'messages/'+tid(me,currentDM)), { from: me, to: currentDM, text, ts:t() });
  dmMsg.value='';
}

async function deleteDM(msgId){
  if(!currentDM) return;
  await remove(ref(db,'messages/'+tid(me,currentDM)+'/'+msgId));
  info('Message deleted.');
}

// ===== ADMIN: Delete user cascade (demo â€“ client side) =====
async function deleteUserCascade(u){
  if(!isAdmin || u==='tosh1') return;
  if(!confirm(`Delete user @${u}? This removes their account, presence, requests, friendships, messages with others, and all group memberships.`)) return;

  // Load data needed for cascade
  const [friendsSnap, groupsSnap, requestsSnap, messagesSnap] = await Promise.all([
    get(child(ref(db),'friendships/'+u)),
    get(child(ref(db),'user_groups/'+u)),
    get(child(ref(db),'requests')),     // all buckets to clean outgoing u
    get(child(ref(db),'messages'))      // delete pairs containing u (best-effort)
  ]);

  const updates = {};
  // core
  updates['users/'+u] = null;
  updates['presence/'+u] = null;
  updates['requests/'+u] = null; // incoming
  // outgoing requests (requests/*/u)
  const reqAll = requestsSnap.val()||{};
  Object.keys(reqAll).forEach(target=>{
    if(reqAll[target] && reqAll[target][u]) updates['requests/'+target+'/'+u] = null;
  });
  // friendships
  const fr = friendsSnap.val()||{};
  Object.keys(fr).forEach(peer=>{
    updates['friendships/'+u+'/'+peer] = null;
    updates['friendships/'+peer+'/'+u] = null;
  });
  // messages: delete any pair key containing u
  const msgsRoot = messagesSnap.val()||{};
  Object.keys(msgsRoot).forEach(pairKey=>{
    if(pairKey.split('__').includes(u)) updates['messages/'+pairKey] = null;
  });
  // groups
  const ug = groupsSnap.val()||{};
  Object.keys(ug).forEach(g=>{
    updates['group_members/'+g+'/'+u] = null;
  });
  updates['user_groups/'+u] = null;

  await update(ref(db), updates);
  info(`@${u} deleted.`);
  // if we were chatting with them, clear
  if(currentDM===u){ currentDM=null; dmWith.textContent='â€”'; dmChat.innerHTML=''; }
}

// events
document.body.addEventListener('click',(e)=>{
  const a=e.target.getAttribute('data-accept'); if(a){ update(ref(db),{['requests/'+me+'/'+a+'/status']:'accepted',['friendships/'+me+'/'+a]:true,['friendships/'+a+'/'+me]:true}); return; }
  const d=e.target.getAttribute('data-decline'); if(d){ update(ref(db),{['requests/'+me+'/'+d+'/status']:'declined'}); return; }
  const o=e.target.getAttribute('data-open-dm'); if(o){ openDM(o); return; }
  const f=e.target.getAttribute('data-add-friend'); if(f){ sendRequest(f); return; }
  const delUser=e.target.getAttribute('data-del-user'); if(delUser){ deleteUserCascade(delUser); return; }
  const delDM=e.target.getAttribute('data-del-dm'); if(delDM){ deleteDM(delDM); return; }
});
document.querySelector('#dmSend').onclick=sendDM;
document.querySelector('#sendReq').onclick=()=>sendRequest();
document.querySelector('#dmMsg').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendDM();}});
</script>
</body></html>

