<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ChatSpace — Groups</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --border:#e6e8ef; --text:#0f172a; --muted:#64748b;
    --accent:#3b82f6; --danger:#ef4444; --bubble:#fff; --me:#eef2ff; --link:#2563eb
  }
  :root[data-theme="dark"]{
    --bg:#0b1220; --card:#0f172a; --border:#1f2a44; --text:#e5e7eb; --muted:#93a4c7;
    --accent:#60a5fa; --danger:#f87171; --bubble:#111827; --me:#1e293b; --link:#93c5fd
  }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Arial;color:var(--text);background:var(--bg)}
  header{position:sticky;top:0;z-index:5;background:var(--card);border-bottom:1px solid var(--border);padding:10px 12px}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
  .left,.right{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:transparent;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  .col{display:flex;flex-direction:column;gap:10px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .input, textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)}
  #gchat{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;scroll-behavior:smooth}
  .bubble{border:1px solid var(--border);background:var(--bubble);border-radius:12px;padding:10px;position:relative}
  .me{background:var(--me)}
  .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  .userItem{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px}
  img.msg{max-width:260px;border-radius:10px;display:block;margin-top:6px}
  .tiny{font-size:12px;color:var(--muted)}
  .pill{padding:2px 6px;border-radius:6px;border:1px solid var(--border);margin-left:6px}
  .actions{display:flex;gap:6px;margin-top:6px}
  .reacts{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .reply{border-left:3px solid var(--border);padding-left:8px;margin:6px 0 4px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="left">
      <strong>ChatSpace</strong>
      <a class="btn" href="./messages.html">💬 Messages</a>
      <a class="btn" href="./groups.html">👥 Groups</a>
    </div>
    <div class="right">
      <button id="themeBtn" class="btn">🌓 Theme: <span id="themeName">Light</span></button>
      <button id="soundBtn" class="btn">🔊 <span id="soundState">On</span></button>
      <button id="notifBtn" class="btn">🔔 Notifications</button>
      <button id="testNotif" class="btn">✅ Test</button>
    </div>
  </div>
</header>

<div class="wrap col">
  <div id="status" class="tiny"></div>

  <!-- identity -->
  <div class="card">
    <div class="row">
      <input id="me" class="input" placeholder="username (e.g. alice)"/>
      <button id="claim" class="btn primary">Use</button>
      <span id="adminBadge" class="tiny pill"></span>
      <span class="tiny">Share: <span id="share" class="mono"></span></span>
    </div>
  </div>

  <div class="grid">
    <!-- left: groups + members + users -->
    <div class="col">
      <div class="card">
        <div class="row"><input id="gname" class="input" placeholder="group name (e.g. class7)"/></div>
        <div class="row"><input id="ginit" class="input" placeholder="initial members (comma, optional)"/></div>
        <div class="row"><button id="gcreate" class="btn primary">Create / Join</button></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">My Groups</h3>
        <div id="myGroups" class="col tiny"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">Members of <span id="gMono" class="mono">—</span></h3>
        <div id="members" class="col tiny"></div>
        <div class="row"><input id="adders" class="input" placeholder="add members (comma)"/></div>
        <div class="row">
          <button id="addBtn" class="btn">Add Members</button>
          <button id="leave" class="btn" style="border-color:var(--danger);color:var(--danger)">Leave</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">Registered Users</h3>
        <div id="registered" class="col"></div>
        <div class="tiny">Add to open group. (As <b>tosh1</b> you can delete users.)</div>
      </div>
    </div>

    <!-- right: chat -->
    <div class="col">
      <div class="card col">
        <div class="row" style="justify-content:space-between">
          <div class="inline">
            <div>Group <span id="gtitle" class="mono">—</span></div>
          </div>
          <div id="typing" class="tiny muted"></div>
        </div>

        <div id="gchat"></div>

        <!-- reply preview -->
        <div id="replyBar" class="reply" style="display:none">
          Replying to <span id="replyMeta"></span>
          <button id="cancelReply" class="btn tiny" style="margin-left:8px">✕</button>
        </div>

        <!-- image PREVIEW bubble -->
        <div id="gpreviewWrap" class="bubble" style="display:none;opacity:.9">
          <div class="muted mono">Preview (not sent)</div>
          <img id="gpreviewImg" class="msg" alt="preview">
        </div>

        <!-- composer -->
        <div class="row"><textarea id="gmsg" placeholder="Message the group… (Enter to send)"></textarea></div>
        <div class="row" style="justify-content:space-between">
          <input id="gfile" type="file" accept="image/*"/>
          <div class="row">
            <button id="gsend" class="btn primary">Send</button>
            <button id="gclear" class="btn">Clear preview</button>
          </div>
        </div>
        <div id="seenBar" class="tiny muted"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, onValue, off, set, update, push, get, child, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

const app = initializeApp({ databaseURL: "https://my-chat-ddcd1-default-rtdb.firebaseio.com/" });
const db = getDatabase(app);
const storage = getStorage(app);

// header utilities (same behavior as messages page)
const root=document.documentElement, themeBtn=$('#themeBtn'), themeName=$('#themeName');
applyTheme(localStorage.getItem('cs_theme')||'light');
function applyTheme(th){ root.setAttribute('data-theme', th==='dark'?'dark':'light'); themeName.textContent=th==='dark'?'Dark':'Light'; localStorage.setItem('cs_theme', th); }
themeBtn.onclick=()=>applyTheme(root.getAttribute('data-theme')==='dark'?'light':'dark');

let soundOn=(localStorage.getItem("cs_sound")||"on")==="on";
$('#soundState').textContent=soundOn?"On":"Off";
$('#soundBtn').onclick=()=>{ soundOn=!soundOn; localStorage.setItem("cs_sound",soundOn?"on":"off"); $('#soundState').textContent=soundOn?"On":"Off"; if(soundOn){ ensureAudio(); ding(); } };
let audioCtx=null; function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } if(audioCtx&&audioCtx.state==="suspended"){ audioCtx.resume(); } }
function ding(){ if(!soundOn) return; ensureAudio(); if(!audioCtx) return; const c=audioCtx; let s=c.currentTime; [[660,0.18],[990,0.28]].forEach(([f,d])=>{ const o=c.createOscillator(), g=c.createGain(); o.type="square"; o.frequency.setValueAtTime(f,s); g.gain.setValueAtTime(0.0001,s); g.gain.exponentialRampToValueAtTime(0.22,s+0.02); g.gain.exponentialRampToValueAtTime(0.0001,s+d); o.connect(g).connect(c.destination); o.start(s); o.stop(s+d+0.01); s+=d+0.02;}); }
window.addEventListener("click", ensureAudio, { once:true });
$('#notifBtn').onclick = async ()=>{ if(!("Notification" in window)) return alert("No Notifications support"); const p=await Notification.requestPermission(); if(p!=="granted") alert("Allow notifications"); else new Notification("Notifications enabled 🎉"); };
$('#testNotif').onclick = ()=>{ if("Notification" in window && Notification.permission==="granted"){ new Notification("Test notification",{body:"Group notifications working"}); } else alert("Enable notifications first."); };

// helpers
const $=s=>document.querySelector(s), t=()=>Date.now();
const esc=s=>(s||"").replace(/[<>&]/g,m=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[m]));
function info(m){ const el=$("#status"); el.textContent=m; setTimeout(()=>el.textContent="",2400); }
function fmtTime(ts){ const d=new Date(ts||Date.now()); return d.toLocaleTimeString(); }

// els
const meBox=$("#me"), claim=$("#claim"), share=$("#share"), adminBadge=$("#adminBadge");
const gname=$("#gname"), ginit=$("#ginit"), gcreate=$("#gcreate");
const myGroups=$("#myGroups"), members=$("#members"), gMono=$("#gMono"), gtitle=$("#gtitle");
const gchat=$("#gchat"), gmsg=$("#gmsg"), gsend=$("#gsend");
const gfile=$("#gfile"), gclear=$("#gclear"), gpreviewWrap=$("#gpreviewWrap"), gpreviewImg=$("#gpreviewImg");
const adders=$("#adders"), addBtn=$("#addBtn"), leaveBtn=$("#leave");
const registered=$("#registered");
const typingEl=$("#typing"), replyBar=$("#replyBar"), replyMeta=$("#replyMeta"), cancelReply=$("#cancelReply"), seenBar=$("#seenBar");

let me=null, admin=false, curG=null, gmRef=null, gmCb=null, reactionsRef=null, reactionsCb=null;
let profilesCache = {};
let replyTo=null, currentMessages=[], groupSeenMap={}, cachedReactions={};

// presence
async function presence(){
  if(!me) return;
  const p=ref(db,'presence/'+me);
  await set(p,{online:true,lastSeen: serverTimestamp()});
  onDisconnect(p).set({online:false,lastSeen: serverTimestamp()});
  setInterval(()=>update(p,{online:true,lastSeen:serverTimestamp()}),30000);
}
async function loadProfile(u){
  if(profilesCache[u]) return profilesCache[u];
  const s=await get(child(ref(db),'profiles/'+u)); profilesCache[u]=s.val()||{}; return profilesCache[u];
}

// identity
async function use(){
  const u=(meBox.value||'').trim().toLowerCase(); if(!u) return;
  const s=await get(child(ref(db),'users/'+u)); if(!s.exists()) await set(ref(db,'users/'+u),{createdAt:t()});
  me=u; admin=(me==='tosh1'); localStorage.setItem("cs_username",me);
  history.replaceState({},'',location.pathname+'?u='+me);
  share.textContent=location.origin+location.pathname+'?u='+me;
  adminBadge.textContent=admin?'Admin: tosh1':'';
  info('Using @'+me+(admin?' (admin)':''));
  presence(); myList(); watchUsers();
}
claim.onclick=use;
const saved=(localStorage.getItem("cs_username")||"").trim(); if(saved){ meBox.value=saved; use(); }

// my groups & open
function myList(){
  onValue(ref(db,'user_groups/'+me),(snap)=>{
    const d=snap.val()||{}; const arr=Object.keys(d).sort();
    myGroups.innerHTML = arr.length ? arr.map(g=>`
      <div class="row"><span>#${esc(g)}</span><button class="btn" data-open="${esc(g)}">Open</button></div>
    `).join('') : '<span class="tiny muted">No groups yet</span>';
  });
}
async function create(){
  if(!me) return info('Use a username first.');
  const g=(gname.value||'').trim().toLowerCase(); if(!g) return;
  await set(ref(db,'groups/'+g),{createdAt:t()});
  const raw=(ginit.value||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  const setu=new Set([me,...raw]); const up={}; setu.forEach(u=>{ up['group_members/'+g+'/'+u]=true; up['user_groups/'+u+'/'+g]=true; });
  await update(ref(db),up); gname.value=''; ginit.value=''; openG(g); info('Group ready.');
}
gcreate.onclick=create;

function render(arr, reactions){
  currentMessages=arr;
  gchat.innerHTML = arr.map(m=>{
    const owns=m.from===me; const canDel=owns||admin;
    const rs=reactions[m.id]||{};
    const tally = (emoji)=> Object.keys(rs[emoji]||{}).length;
    const youReacted=(emoji)=> !!(rs[emoji] && rs[emoji][me]);
    const replyHtml = m.replyTo ? `<div class="reply tiny">@${esc(m.replyTo.from)}: ${esc(m.replyTo.text||'')}</div>` : '';
    const edited = m.edited ? `<span class="tiny muted"> (edited)</span>` : '';
    // who has seen this (any member whose read ts >= m.ts)
    const seenBy = Object.entries(groupSeenMap).filter(([u,ts])=>ts>=m.ts && u!==m.from).map(([u])=>'@'+u).slice(0,3);
    const seenText = seenBy.length? `<span class="tiny muted">Seen by ${seenBy.join(', ')}${seenBy.length===3?'…':''}</span>` : '';
    return `<div class="bubble ${owns?'me':''}" data-id="${esc(m.id)}">
      <div class="muted mono">@${esc(m.from)} <span class="tiny muted">• ${fmtTime(m.ts)}</span></div>
      ${replyHtml}
      ${m.text?`<div>${esc(m.text)}${edited}</div>`:''}
      ${m.imageUrl?`<img class="msg" src="${esc(m.imageUrl)}" alt="img">`:''}
      <div class="actions">
        <button class="btn tiny" data-reply="${esc(m.id)}">↩ Reply</button>
        <button class="btn tiny" data-react="${esc(m.id)}" data-emoji="👍">${youReacted('👍')?'✅':''} 👍 ${tally('👍')||''}</button>
        <button class="btn tiny" data-react="${esc(m.id)}" data-emoji="❤️">${youReacted('❤️')?'✅':''} ❤️ ${tally('❤️')||''}</button>
        <button class="btn tiny" data-react="${esc(m.id)}" data-emoji="😂">${youReacted('😂')?'✅':''} 😂 ${tally('😂')||''}</button>
        ${owns?`<button class="btn tiny" data-edit="${esc(m.id)}">✏ Edit</button>`:''}
        ${canDel?`<button class="btn tiny" data-del="${esc(m.id)}">🗑</button>`:''}
        <span style="flex:1"></span>${seenText}
      </div>
    </div>`;
  }).join('');
  gchat.scrollTop = gchat.scrollHeight;
}

let typingUnsub=null, readsUnsub=null, reactsUnsub=null;
function openG(g){
  curG=g; localStorage.setItem("cs_last_group",g);
  gtitle.textContent='#'+g; gMono.textContent='#'+g; gchat.innerHTML='';
  if(gmRef&&gmCb) off(gmRef,gmCb); if(typingUnsub) off(typingUnsub.ref, typingUnsub.cb); if(readsUnsub) off(readsUnsub.ref, readsUnsub.cb); if(reactsUnsub) off(reactsUnsub.ref, reactsUnsub.cb);

  // messages
  gmRef = ref(db,'group_messages/'+g);
  let last=0;
  gmCb = (snap)=>{
    const d=snap.val()||{}; const arr=Object.entries(d).map(([id,m])=>({id,...m})).sort((a,b)=>a.ts-b.ts);
    if(arr.length>last){ const L=arr[arr.length-1]; if(L && L.from!==me){ ding(); if("Notification" in window && Notification.permission==="granted"){ new Notification('New in #'+g,{body:'@'+L.from+(L.text?': '+L.text:' (photo)')}); } } }
    last=arr.length;
    // update my read ts for group
    const lastTs = arr.length? arr[arr.length-1].ts : 0;
    if(lastTs) set(ref(db,'reads_group/'+g+'/'+me), lastTs);
    render(arr, cachedReactions);
  };
  onValue(gmRef, gmCb);

  // typing watch (anyone typing except me)
  const typRef = ref(db,'typing_group/'+g);
  const typCb = s=>{
    const d=s.val()||{}; const who = Object.keys(d).filter(u=>u!==me && d[u]);
    typingEl.textContent = who.length? `${who[0]} is typing…` : '';
  };
  onValue(typRef, typCb); typingUnsub={ref:typRef, cb:typCb};

  // group reads (map username->ts)
  const rdRef = ref(db,'reads_group/'+g);
  const rdCb = s=>{ groupSeenMap = s.val()||{}; render(currentMessages, cachedReactions); };
  onValue(rdRef, rdCb); readsUnsub={ref:rdRef, cb:rdCb};

  // reactions
  const rRef = ref(db,'reactions_group/'+g);
  const rCb = s=>{ cachedReactions = s.val()||{}; render(currentMessages, cachedReactions); };
  onValue(rRef, rCb); reactsUnsub={ref:rRef, cb:rCb};
}
document.body.addEventListener('click',(e)=>{
  const o=e.target.getAttribute('data-open'); if(o){ openG(o); return; }
});

// typing
let typingTimer=null;
function setTyping(is){
  if(!curG) return;
  set(ref(db,'typing_group/'+curG+'/'+me), !!is);
  if(is){
    clearTimeout(typingTimer);
    typingTimer=setTimeout(()=>set(ref(db,'typing_group/'+curG+'/'+me), false), 2500);
  }
}
gmsg.addEventListener('input',()=>setTyping(true));

// local preview
gfile.addEventListener('change', ()=>{
  if(gfile.files && gfile.files[0]){
    const url = URL.createObjectURL(gfile.files[0]);
    gpreviewImg.src = url; gpreviewWrap.style.display='block';
  }else{ gpreviewWrap.style.display='none'; gpreviewImg.removeAttribute('src'); }
});
gclear.onclick=()=>{ gfile.value=''; gpreviewWrap.style.display='none'; gpreviewImg.removeAttribute('src'); };

// send to group
async function sendG(){
  if(!curG) return;
  const text=(gmsg.value||'').trim(); let imageUrl=null;
  if(gfile.files && gfile.files[0]){
    const f=gfile.files[0]; const path=`uploads/${me}/${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
    const upRef=sref(storage,path); await uploadBytes(upRef,f); imageUrl=await getDownloadURL(upRef);
  }
  if(!text && !imageUrl && !replyTo) return;
  await push(ref(db,'group_messages/'+curG),{from:me,text,imageUrl,ts:t(), ...(replyTo?{replyTo}:{})});
  gmsg.value=''; if(imageUrl){ gfile.value=''; gpreviewWrap.style.display='none'; gpreviewImg.removeAttribute('src'); }
  setTyping(false); setReply(null);
}
gsend.onclick=sendG;
gmsg.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendG(); } });

// reply, react, edit, delete
function setReply(m){
  replyTo = m ? { id:m.id, from:m.from, text:(m.text||'') } : null;
  if(replyTo){ replyMeta.textContent = `@${replyTo.from}: ${replyTo.text.slice(0,80)}`; replyBar.style.display='block'; }
  else { replyBar.style.display='none'; }
}
cancelReply.onclick=()=>setReply(null);

document.body.addEventListener('click', async (e)=>{
  const del=e.target.getAttribute('data-del'); if(del){ await remove(ref(db,'group_messages/'+curG+'/'+del)); return; }
  const rp=e.target.getAttribute('data-reply'); if(rp){ const m=currentMessages.find(x=>x.id===rp); if(m) setReply(m); return; }
  const ed=e.target.getAttribute('data-edit'); if(ed){
    const node=await get(child(ref(db),'group_messages/'+curG+'/'+ed));
    const m=node.val(); if(!m || m.from!==me) return;
    const text=prompt("Edit message:", m.text||""); if(text===null) return;
    await update(ref(db,'group_messages/'+curG+'/'+ed), { text, edited:true }); return;
  }
  const rx=e.target.getAttribute('data-react'); if(rx){
    const em=e.target.getAttribute('data-emoji');
    const path='reactions_group/'+curG+'/'+rx+'/'+em+'/'+me;
    const cur=await get(child(ref(db), path)); await set(ref(db, path), cur.exists()? null : true); return;
  }
});

// add members / leave / users
async function addMembers(list){
  if(!curG||!me) return;
  const raw=(typeof list==='string'?list:(adders.value||'')).split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  if(!raw.length) return;
  const up={}; raw.forEach(u=>{ up['group_members/'+curG+'/'+u]=true; up['user_groups/'+u+'/'+curG]=true; });
  await update(ref(db),up); adders.value=''; info('Added.');
}
addBtn.onclick=()=>addMembers();

async function leave(){
  if(!curG||!me) return;
  const up={}; up['group_members/'+curG+'/'+me]=null; up['user_groups/'+me+'/'+curG]=null;
  await update(ref(db),up); info('Left #'+curG); curG=null; gtitle.textContent='—'; gMono.textContent='—'; gchat.innerHTML=''; members.innerHTML='';
}
leaveBtn.onclick=leave;

function watchUsers(){
  onValue(ref(db,'users'), async (su)=>{
    const users=su.val()||{}; const names=Object.keys(users).sort();
    await Promise.all(names.map(n=>loadProfile(n)));
    registered.innerHTML = names.map(u=>{
      const p=profilesCache[u]||{}; const tag = p.displayName ? ` — ${esc(p.displayName)}` : '';
      return `<div class="userItem">
        <span>@${esc(u)}<span class="tiny">${tag}</span></span>
        <div class="row">
          <button class="btn" data-addu="${esc(u)}">Add to Group</button>
          ${admin && u!=='tosh1' ? `<button class="btn danger" data-deluser="${esc(u)}">Delete</button>`:''}
        </div>
      </div>`;
    }).join('');
  });
}
document.body.addEventListener('click',(e)=>{
  const addU=e.target.getAttribute('data-addu'); if(addU){ addMembers(addU); return; }
  const du=e.target.getAttribute('data-deluser'); if(du){ delUser(du); return; }
});

async function delUser(u){
  if(!(me==='tosh1')||u==='tosh1') return;
  if(!confirm(`Delete @${u}?`)) return;
  const [friendsSnap, groupsSnap, requestsSnap, messagesSnap]=await Promise.all([
    get(child(ref(db),'friendships/'+u)), get(child(ref(db),'user_groups/'+u)),
    get(child(ref(db),'requests')), get(child(ref(db),'messages'))
  ]);
  const up={}; up['users/'+u]=null; up['presence/'+u]=null; up['requests/'+u]=null;
  const reqAll=requestsSnap.val()||{}; Object.keys(reqAll).forEach(target=>{ if(reqAll[target]?.[u]) up['requests/'+target+'/'+u]=null; });
  const fr=friendsSnap.val()||{}; Object.keys(fr).forEach(p=>{ up['friendships/'+u+'/'+p]=null; up['friendships/'+p+'/'+u]=null; });
  const msgsRoot=messagesSnap.val()||{}; Object.keys(msgsRoot).forEach(k=>{ if(k.split('__').includes(u)) up['messages/'+k]=null; });
  const ug=groupsSnap.val()||{}; Object.keys(ug).forEach(g=>{ up['group_members/'+g+'/'+u]=null; });
  up['user_groups/'+u]=null;
  await update(ref(db),up); info('@'+u+' deleted');
}
</script>
</body>
</html>

